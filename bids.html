<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Financing Bids | Pecos</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&display=swap" rel="stylesheet">

<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>

<style>
body{margin:0;font-family:Montserrat;background:#f4f6f9}
header{background:#003366;color:#fff;padding:14px 20px;display:flex;justify-content:space-between;align-items:center}
h2,h3{margin:0;color:#003366}
.page{max-width:1400px;margin:20px auto;padding:0 16px}
.grid{display:grid;grid-template-columns:2.5fr 1.5fr;gap:20px}
.card{background:#fff;border-radius:10px;padding:16px;border:1px solid #eef2f6}
table{width:100%;border-collapse:collapse;font-size:14px}
th,td{padding:10px;border-bottom:1px solid #eee;text-align:left}
th{background:#003366;color:#fff;position:sticky;top:0}
input,select{width:100%;padding:10px;margin-bottom:12px;border-radius:8px;border:1px solid #ccc}
.btn{background:#003366;color:#fff;border:none;padding:12px;border-radius:8px;font-weight:700;width:100%;cursor:pointer}
.btn:hover{background:#002a53}
.badge{padding:4px 8px;border-radius:6px;font-size:12px;font-weight:600}
.green{background:#e6f4ea;color:#1b7f3a}
.red{background:#fdecea;color:#b71c1c}
.gray{background:#eee;color:#444}
footer{text-align:center;margin-top:20px;color:#666;font-size:13px}
.admin{background:#fff4e5;border:1px solid #ffd9a8}
</style>
</head>

<body style="display:none">

<header>
  <h2>Pecos – Financing Bids</h2>
  <div id="userInfo"></div>
</header>

<div class="page">
  <div class="grid">

    <!-- LIVE LENDER ORDER BOOK -->
    <div class="card">
      <h3>Live Lender Order Book</h3>
      <div style="max-height:420px;overflow:auto;margin-top:10px">
        <table>
          <thead>
            <tr>
              <th>Lender</th>
              <th>Amount (₹)</th>
              <th>Monthly Interest</th>
            </tr>
          </thead>
          <tbody id="lenderTable">
            <tr><td colspan="3">Loading...</td></tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- BID PANEL -->
    <div class="card">
      <h3>Place Borrowing Bid</h3>
      <form id="bidForm">
        <input type="number" id="amount" placeholder="Amount Required (₹)" required>
        <input type="number" step="0.01" id="interest" placeholder="Max Monthly Interest (%)" required>
        <select id="lenderId" required>
          <option value="">Select Lender</option>
        </select>
        <p><strong>Broker Fee (0.25%):</strong> ₹<span id="fee">0</span></p>
        <button class="btn">Submit Bid</button>
      </form>
      <p id="msg" style="font-weight:700;margin-top:10px"></p>
    </div>

  </div>

  <!-- ADMIN PANEL -->
  <div id="adminPanel" class="card admin" style="display:none;margin-top:20px">
    <h3>Admin – Pending Bids</h3>
    <div id="adminBids"></div>
  </div>

</div>

<footer>
This is a private financing facilitation platform. Pecos does not guarantee returns or repayments.
</footer>

<script>
/* ================= FIREBASE CONFIG ================= */
/* YOU WILL SHARE FINAL DETAILS NEXT */
const firebaseConfig = {
  apiKey: "PASTE_LATER",
  authDomain: "PASTE_LATER",
  projectId: "PASTE_LATER"
};
firebase.initializeApp(firebaseConfig);

const auth = firebase.auth();
const db = firebase.firestore();

/* ================= AUTH PROTECTION ================= */
auth.onAuthStateChanged(async user=>{
  if(!user){ window.location.href="index.html"; return; }
  document.body.style.display="block";
  document.getElementById('userInfo').innerText = user.email;

  const member = await db.collection("members").doc(user.uid).get();
  if(member.exists && member.data().role === "admin"){
    document.getElementById("adminPanel").style.display="block";
    loadAdminBids();
  }

  loadLendersLive();
});

/* ================= LIVE LENDER BOOK ================= */
function loadLendersLive(){
  db.collection("lenders").onSnapshot(snapshot=>{
    const tbody = document.getElementById("lenderTable");
    const select = document.getElementById("lenderId");
    tbody.innerHTML="";
    select.innerHTML='<option value="">Select Lender</option>';

    snapshot.forEach(doc=>{
      const d = doc.data();
      tbody.innerHTML += `
        <tr>
          <td>${d.name}</td>
          <td>₹${d.amountAvailable}</td>
          <td><span class="badge green">${d.monthlyInterest}%</span></td>
        </tr>`;
      select.innerHTML += `
        <option value="${doc.id}">
          ${d.name} – ₹${d.amountAvailable} @ ${d.monthlyInterest}%
        </option>`;
    });
  });
}

/* ================= BROKER FEE ================= */
amount.addEventListener("input",()=>{
  fee.innerText = (Number(amount.value||0)*0.0025).toFixed(2);
});

/* ================= SUBMIT BID ================= */
bidForm.addEventListener("submit",async e=>{
  e.preventDefault();
  const user = auth.currentUser;
  const amt = Number(amount.value);
  const int = Number(interest.value);
  const lid = lenderId.value;
  const brokerFee = amt*0.0025;

  await db.collection("bids").add({
    borrowerId:user.uid,
    lenderId:lid,
    amount:amt,
    maxInterest:int,
    brokerFee,
    status:"Pending",
    createdAt:new Date()
  });

  msg.style.color="green";
  msg.innerText="Bid placed successfully.";
  bidForm.reset();
  fee.innerText="0";

  matchEngine(); // AUTO MATCH
});

/* ================= MATCHING ENGINE ================= */
async function matchEngine(){
  const bidsSnap = await db.collection("bids")
    .where("status","==","Pending")
    .get();

  for(const bidDoc of bidsSnap.docs){
    const bid = bidDoc.data();
    const lenderDoc = await db.collection("lenders").doc(bid.lenderId).get();
    if(!lenderDoc.exists) continue;

    const lender = lenderDoc.data();
    if(lender.monthlyInterest <= bid.maxInterest && lender.amountAvailable >= bid.amount){

      const emi = bid.amount + (bid.amount*lender.monthlyInterest/100);

      const matchRef = await db.collection("matches").add({
        lenderId:bid.lenderId,
        borrowerId:bid.borrowerId,
        amount:bid.amount,
        interest:lender.monthlyInterest,
        emi,
        brokerFee:bid.brokerFee,
        status:"Active",
        createdAt:new Date()
      });

      await lenderDoc.ref.update({
        amountAvailable:lender.amountAvailable - bid.amount
      });

      await bidDoc.ref.update({status:"Matched"});

      // repayment schedule (12 months default)
      for(let i=1;i<=12;i++){
        await db.collection("repayments").add({
          matchId:matchRef.id,
          month:i,
          amount:emi,
          paid:false
        });
      }

      await db.collection("brokerLedger").add({
        matchId:matchRef.id,
        fee:bid.brokerFee,
        createdAt:new Date()
      });

      return;
    }
  }
}

/* ================= ADMIN PANEL ================= */
async function loadAdminBids(){
  db.collection("bids").where("status","==","Pending")
    .onSnapshot(snapshot=>{
      let html="<table><tr><th>Borrower</th><th>Amount</th><th>Interest</th><th>Action</th></tr>";
      snapshot.forEach(doc=>{
        const d=doc.data();
        html+=`
          <tr>
            <td>${d.borrowerId}</td>
            <td>₹${d.amount}</td>
            <td>${d.maxInterest}%</td>
            <td>
              <button onclick="approveBid('${doc.id}')" class="btn">Approve</button>
            </td>
          </tr>`;
      });
      html+="</table>";
      adminBids.innerHTML=html;
    });
}

async function approveBid(id){
  await db.collection("bids").doc(id).update({status:"Approved"});
  matchEngine();
}
</script>

</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Financing Bids | Pecos</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&display=swap" rel="stylesheet">

<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>

<style>
body{margin:0;font-family:Montserrat;background:#f4f6f9}
header{background:#003366;color:#fff;padding:14px 20px;display:flex;justify-content:space-between;align-items:center}
header h2{margin:0}
.page{max-width:1300px;margin:20px auto;padding:0 16px}

.grid{display:grid;grid-template-columns:2fr 1fr;gap:20px}
.card{background:#fff;border-radius:10px;padding:16px;border:1px solid #eef2f6}
h3{margin-top:0;color:#003366}

table{width:100%;border-collapse:collapse;font-size:14px}
th,td{padding:10px;border-bottom:1px solid #eee;text-align:left}
th{background:#003366;color:#fff;position:sticky;top:0}

input,select{width:100%;padding:10px;margin-bottom:12px;border-radius:8px;border:1px solid #ccc}
.btn{background:#003366;color:#fff;border:none;padding:12px;border-radius:8px;font-weight:700;width:100%;cursor:pointer}
.btn:hover{background:#002a53}

.badge{padding:4px 8px;border-radius:6px;font-size:12px;font-weight:600}
.green{background:#e6f4ea;color:#1b7f3a}
.red{background:#fdecea;color:#b71c1c}

footer{text-align:center;margin-top:20px;color:#666;font-size:13px}
</style>
</head>

<body style="display:none">

<header>
  <h2>Pecos – Financing Bids</h2>
  <div id="userInfo"></div>
</header>

<div class="page">
  <div class="grid">

    <!-- LIVE LENDER ORDER BOOK -->
    <div class="card">
      <h3>Live Lender Order Book</h3>
      <div style="max-height:420px;overflow:auto">
        <table>
          <thead>
            <tr>
              <th>Lender</th>
              <th>Amount (₹)</th>
              <th>Monthly Interest</th>
            </tr>
          </thead>
          <tbody id="lenderTable">
            <tr><td colspan="3">Loading...</td></tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- BID PANEL -->
    <div class="card">
      <h3>Place Borrowing Bid</h3>
      <form id="bidForm">
        <input type="number" id="amount" placeholder="Amount Required (₹)" required>
        <input type="number" step="0.01" id="interest" placeholder="Monthly Interest (%)" required>
        <select id="lenderId" required>
          <option value="">Select Lender</option>
        </select>
        <p><strong>Broker Fee (0.25%):</strong> ₹<span id="fee">0</span></p>
        <button class="btn">Submit Bid</button>
      </form>
      <p id="msg" style="font-weight:700;margin-top:10px"></p>
    </div>

  </div>
</div>

<footer>© 2025 Pecos</footer>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyDnbqKwqvg9BoAjpgMBFCr3ZBOFOcuvZxs",
  authDomain: "pecos-432b5.firebaseapp.com",
  projectId: "pecos-432b5",
};
firebase.initializeApp(firebaseConfig);

const auth = firebase.auth();
const db = firebase.firestore();

/* AUTH PROTECTION */
auth.onAuthStateChanged(user=>{
  if(!user){ window.location.href="index.html"; return; }
  document.body.style.display="block";
  document.getElementById('userInfo').innerText = user.email;
  loadLendersLive();
});

/* LIVE LENDER BOOK */
function loadLendersLive(){
  db.collection("lenders").onSnapshot(snapshot=>{
    const tbody = document.getElementById("lenderTable");
    const select = document.getElementById("lenderId");
    tbody.innerHTML="";
    select.innerHTML='<option value="">Select Lender</option>';

    if(snapshot.empty){
      tbody.innerHTML='<tr><td colspan="3">No lenders available</td></tr>';
      return;
    }

    snapshot.forEach(doc=>{
      const d = doc.data();
      tbody.innerHTML += `
        <tr>
          <td>${d.name}</td>
          <td>₹${d.amountAvailable}</td>
          <td><span class="badge green">${d.monthlyInterest}%</span></td>
        </tr>`;
      select.innerHTML += `
        <option value="${doc.id}">
          ${d.name} – ₹${d.amountAvailable} @ ${d.monthlyInterest}%
        </option>`;
    });
  });
}

/* LIVE BROKER FEE CALC */
document.getElementById("amount").addEventListener("input",()=>{
  const amt = Number(amount.value||0);
  document.getElementById("fee").innerText = (amt*0.0025).toFixed(2);
});

/* SUBMIT BID */
document.getElementById("bidForm").addEventListener("submit",async e=>{
  e.preventDefault();
  const user = auth.currentUser;

  const amt = Number(amount.value);
  const int = Number(interest.value);
  const lid = lenderId.value;
  const fee = amt*0.0025;

  try{
    await db.collection("bids").add({
      borrowerId:user.uid,
      lenderId:lid,
      amount:amt,
      monthlyInterest:int,
      brokerFee:fee,
      status:"Pending",
      createdAt:new Date()
    });
    msg.style.color="green";
    msg.innerText=`Bid placed successfully. Broker fee ₹${fee.toFixed(2)}`;
    bidForm.reset();
    document.getElementById("fee").innerText="0";
  }catch(err){
    msg.style.color="red";
    msg.innerText="Error placing bid";
  }
});
</script>

</body>
</html>

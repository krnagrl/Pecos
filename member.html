<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Member Dashboard | Pecos</title>

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-storage-compat.js"></script>

  <style>
    :root {--accent:#4a4a7d;--accent-2:#c33;--bg:#f9f5d7}
    body {background-color:var(--bg);font-family:Verdana,Segoe UI,Roboto,sans-serif;margin:0;padding:0}
    .container {max-width:1100px;width:95%;margin:30px auto;border:4px solid var(--accent);background-color:#fffce8;box-shadow:0 0 10px rgba(0,0,0,.12)}
    header {background-color:var(--accent);color:#fff;padding:12px 18px;display:flex;justify-content:space-between;align-items:center}
    .brand {display:flex;align-items:center;gap:12px}
    header img {height:40px}
    header nav a {color:#fff;text-decoration:none;margin-left:10px}
    .content {display:flex;gap:18px;padding:18px}
    .sidebar {width:260px;background:#f7f3c6;padding:12px;border-right:2px solid #ddd}
    .sidebar h3 {background-color:var(--accent-2);color:white;padding:8px;text-align:center;margin:0}
    .sidebar ul {list-style:none;padding:8px;margin:8px 0}
    .sidebar li {margin:8px 0}
    .sidebar a {color:#333;text-decoration:none}
    .main {flex:1;background:#fffef0;padding:16px}
    .profile-card {background:#fff8cc;border:1px solid #ddd;padding:12px;border-radius:8px;text-align:center}
    .profile-photo {width:100%;height:200px;background:#eee;border-radius:6px;object-fit:cover}
    .muted {color:#666;font-size:13px}
    .form-row {display:flex;flex-direction:column;margin-bottom:10px}
    label {font-weight:600;margin-bottom:6px}
    input[type=text],input[type=email],input[type=tel]{padding:8px;border:1px solid #ccc;border-radius:4px}
    button {background:var(--accent-2);color:#fff;border:none;padding:8px 12px;border-radius:4px;cursor:pointer}
    footer {background:var(--accent);color:#fff;text-align:center;padding:10px;margin-top:18px}
    @media(max-width:900px){.content{flex-direction:column}.sidebar{width:100%}}
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div class="brand">
        <img src="pecos.png" alt="Pecos Logo" />
        <div>
          <div style="font-weight:700;font-size:18px">Pecos</div>
          <div style="font-size:12px;color:#fffaa0">Member Dashboard</div>
        </div>
      </div>
      <nav>
        <div id="welcome-message">Checking login...</div>
        <a href="#" id="nav-logout">Logout</a>
      </nav>
    </header>

    <div class="content">
      <aside class="sidebar">
        <h3>Dashboard Menu</h3>
        <ul>
          <li><a href="#overview" onclick="showSection('overview')">Overview</a></li>
          <li><a href="#funds" onclick="showSection('funds')">Club Funds</a></li>
          <li><a href="#profile" onclick="showSection('profile')">Profile Settings</a></li>
        </ul>
      </aside>

      <main class="main">
        <!-- OVERVIEW -->
        <div id="overview" class="section">
          <div class="profile-card">
            <img id="profile-photo" class="profile-photo" src="https://via.placeholder.com/400x200?text=No+Photo" alt="Profile Photo" />
            <div style="margin-top:8px">
              <div style="font-weight:700;font-size:16px" id="profile-name">Member Name</div>
              <div class="muted" id="profile-id">Member ID: -</div>
              <div class="muted" id="profile-since">Member since: -</div>
              <div class="muted" id="profile-email">Email: -</div>
              <div class="muted" id="profile-phone">Phone: -</div>
            </div>
            <div style="margin-top:10px">
              <button onclick="downloadStatement()">Download Statement</button>
            </div>
          </div>
        </div>

        <!-- CLUB FUNDS -->
        <div id="funds" class="section" style="display:none">
          <h2>Club Funds</h2>
          <p class="muted">Total funds available for club operations and development.</p>
          <div class="card" style="background:#fff8cc;border:1px solid #ddd;padding:12px;border-radius:8px">
            <h3 id="club-funds">₹0</h3>
          </div>
        </div>

        <!-- PROFILE SETTINGS -->
        <div id="profile" class="section" style="display:none">
          <h2>Profile Settings</h2>
          <div style="display:flex;gap:12px;flex-wrap:wrap">
            <div style="flex:1;min-width:260px">
              <img id="edit-photo-preview" src="https://via.placeholder.com/400x200?text=No+Photo"
                   style="width:100%;height:200px;object-fit:cover;border-radius:6px;border:1px solid #ddd" />
              <input type="file" id="upload-photo" accept="image/*" style="margin-top:8px" />
            </div>
            <div style="flex:2;min-width:260px">
              <div class="form-row">
                <label>Name</label>
                <input id="edit-name" type="text" />
              </div>
              <div class="form-row">
                <label>Email (readonly)</label>
                <input id="edit-email" type="email" readonly />
              </div>
              <div class="form-row">
                <label>Phone</label>
                <input id="edit-phone" type="tel" />
              </div>
              <div class="form-row">
                <label>Member ID</label>
                <input id="edit-member-id" type="text" readonly />
              </div>
              <div class="form-row">
                <label>Member Since</label>
                <input id="edit-member-since" type="text" readonly />
              </div>
              <div style="display:flex;gap:8px;margin-top:10px">
                <button id="save-profile">Save Profile</button>
                <button onclick="showSection('overview')">Back</button>
              </div>
            </div>
          </div>
        </div>
      </main>
    </div>

    <footer>© 2025 Pecos | Registered in 2020</footer>
  </div>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyDnbqKwqvg9BoAjpgMBFCr3ZBOFOcuvZxs",
      authDomain: "pecos-432b5.firebaseapp.com",
      projectId: "pecos-432b5",
      storageBucket: "pecos-432b5.appspot.com"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();
    const storage = firebase.storage();

    function $(id){return document.getElementById(id)}
    function showSection(id){
      document.querySelectorAll('.section').forEach(s=>s.style.display='none');
      const el = $(id);
      if(el) el.style.display='block';
      window.scrollTo({top:0,behavior:'smooth'});
    }

    auth.onAuthStateChanged(async user => {
      if(!user){ window.location.href='login.html'; return; }
      $('welcome-message').innerText = `Welcome, ${user.displayName || user.email}`;
      await loadMemberData(user);
      showSection('overview');
    });

    $('nav-logout').addEventListener('click', e=>{
      e.preventDefault(); auth.signOut().then(()=>window.location.href='login.html');
    });

    async function loadMemberData(user){
      const docRef = db.collection('members').doc(user.uid);
      const snap = await docRef.get();
      let data = {};
      if(snap.exists){ data = snap.data(); }
      else {
        data = {
          displayName: user.displayName || user.email.split('@')[0],
          email: user.email,
          phone: "",
          memberID: 'M-'+user.uid.slice(0,6).toUpperCase(),
          memberSince: new Date().toISOString().slice(0,10),
          clubFunds: 0,
          photoURL: user.photoURL || null
        };
        await docRef.set(data);
      }

      $('profile-name').innerText = data.displayName;
      $('profile-id').innerText = 'Member ID: ' + data.memberID;
      $('profile-since').innerText = 'Member since: ' + data.memberSince;
      $('profile-email').innerText = 'Email: ' + data.email;
      $('profile-phone').innerText = 'Phone: ' + (data.phone || '-');
      $('profile-photo').src = data.photoURL || 'https://via.placeholder.com/400x200?text=No+Photo';
      $('club-funds').innerText = '₹' + Number(data.clubFunds || 0).toLocaleString('en-IN');

      $('edit-name').value = data.displayName;
      $('edit-email').value = data.email;
      $('edit-phone').value = data.phone || '';
      $('edit-member-id').value = data.memberID;
      $('edit-member-since').value = data.memberSince;
      $('edit-photo-preview').src = data.photoURL || 'https://via.placeholder.com/400x200?text=No+Photo';
    }

    $('save-profile').addEventListener('click', async ()=>{
      const user = auth.currentUser; if(!user) return;
      const name = $('edit-name').value.trim();
      const phone = $('edit-phone').value.trim();
      const file = $('upload-photo').files[0];
      const docRef = db.collection('members').doc(user.uid);
      let photoURL = $('edit-photo-preview').src;
      if(file){
        const storageRef = storage.ref().child(`members/${user.uid}/profile.jpg`);
        const snap = await storageRef.put(file);
        photoURL = await snap.ref.getDownloadURL();
      }
      await docRef.update({displayName:name,phone,photoURL});
      await user.updateProfile({displayName:name,photoURL});
      alert('Profile updated');
      loadMemberData(user);
      showSection('overview');
    });

    $('upload-photo').addEventListener('change', e=>{
      const f = e.target.files[0]; if(!f) return;
      const url = URL.createObjectURL(f); $('edit-photo-preview').src = url;
    });

    function downloadStatement(){
      const user = auth.currentUser; if(!user) return;
      db.collection('members').doc(user.uid).get().then(snap=>{
        const data = snap.data()||{};
        const rows = [
          ['Member Name', data.displayName],
          ['Email', data.email],
          ['Phone', data.phone || '-'],
          ['Member ID', data.memberID],
          ['Member Since', data.memberSince],
          ['Club Funds', data.clubFunds || 0]
        ];
        const csv = rows.map(r=>r.join(',')).join('\n');
        const blob = new Blob([csv], {type:'text/csv'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a'); a.href=url; a.download='pecos-statement.csv'; a.click(); URL.revokeObjectURL(url);
      });
    }
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Business Dashboard | Pecos</title>
<link rel="icon" href="pecos.png">
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&display=swap" rel="stylesheet">

<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body{font-family:Montserrat;background:#f4f6f9;margin:0;display:none}
header{background:#003366;color:#fff;padding:16px;font-weight:700}
.page{max-width:1200px;margin:20px auto;padding:0 16px}
.grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:16px}
.card{background:#fff;padding:16px;border-radius:10px;box-shadow:0 2px 6px rgba(0,0,0,.06)}
.card h3{margin-top:0;color:#003366}
input,button{width:100%;padding:10px;margin-top:8px;border-radius:8px;border:1px solid #ccc}
button{background:#003366;color:#fff;font-weight:700;border:none;cursor:pointer}
canvas{background:#fff;padding:16px;border-radius:10px}
</style>
</head>

<body>
<header>Pecos — Business Growth Dashboard</header>

<div class="page">

<div class="grid">
  <div class="card">
    <h3>Add Monthly Income</h3>
    <input type="month" id="month">
    <input placeholder="Interest" type="number" id="interest">
    <input placeholder="Dividend" type="number" id="dividend">
    <input placeholder="Rental" type="number" id="rental">
    <input placeholder="Trading" type="number" id="trading">
    <input placeholder="Brokerage" type="number" id="brokerage">
    <input placeholder="Other" type="number" id="other">
    <button onclick="saveMonth()">Add Month</button>
  </div>

  <div class="card">
    <h3>Total Income</h3>
    <h1 id="total">₹ 0</h1>
    <p id="months">0 months tracked</p>
  </div>
</div>

<br>

<canvas id="growthChart"></canvas>
<br>
<canvas id="breakupChart"></canvas>

</div>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyDnbqKwqvg9BoAjpgMBFCr3ZBOFOcuvZxs",
  authDomain: "pecos-432b5.firebaseapp.com",
  projectId: "pecos-432b5"
};
firebase.initializeApp(firebaseConfig);

const auth = firebase.auth();
const db = firebase.firestore();

auth.onAuthStateChanged(async user=>{
  if(!user) return location.href="index.html";
  const snap = await db.collection("members").doc(user.uid).get();
  if(!snap.exists || snap.data().role!=="admin") return location.href="member.html";
  document.body.style.display="block";
  loadCharts();
});

async function saveMonth(){
  const data = {
    monthKey: month.value,
    interestIncome:+interest.value||0,
    dividendIncome:+dividend.value||0,
    rentalIncome:+rental.value||0,
    tradingIncome:+trading.value||0,
    brokerageIncome:+brokerage.value||0,
    otherIncome:+other.value||0,
    createdAt:new Date()
  };
  data.totalIncome = Object.values(data).slice(1,7).reduce((a,b)=>a+b,0);
  await db.collection("businessIncomeHistory").add(data);
  alert("Month added successfully");
  loadCharts();
}

async function loadCharts(){
  const snap = await db.collection("businessIncomeHistory")
    .orderBy("monthKey").get();

  let labels=[], totals=[], grand=0;

  snap.forEach(d=>{
    labels.push(d.data().monthKey);
    totals.push(d.data().totalIncome);
    grand += d.data().totalIncome;
  });

  total.innerText="₹ "+grand;
  months.innerText=snap.size+" months tracked";

  new Chart(growthChart,{
    type:"line",
    data:{labels,datasets:[{label:"Monthly Income",data:totals,borderColor:"#003366"}]}
  });

  const last = snap.docs[snap.size-1]?.data();
  if(!last) return;

  new Chart(breakupChart,{
    type:"bar",
    data:{
      labels:["Interest","Dividend","Rental","Trading","Brokerage","Other"],
      datasets:[{data:[
        last.interestIncome,last.dividendIncome,last.rentalIncome,
        last.tradingIncome,last.brokerageIncome,last.otherIncome
      ],backgroundColor:"#003366"}]
    }
  });
}
</script>
</body>
</html>

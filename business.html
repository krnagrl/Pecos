<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<link rel="icon" type="image/png" href="pecos.png"/>
<title>Business Dashboard | Pecos</title>

<!-- Font -->
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&display=swap" rel="stylesheet">

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
*{box-sizing:border-box}
html,body{margin:0;font-family:'Montserrat',sans-serif;background:#f4f6f9;color:#222}
body{display:none}

header{background:#003366;color:#fff;display:flex;align-items:center;padding:14px 20px}
.brand{display:flex;align-items:center;gap:12px}
.brand img{height:36px}
.brand .title{font-weight:700;font-size:18px}

.page{max-width:1200px;margin:20px auto;padding:0 16px}
.layout{display:grid;grid-template-columns:260px 1fr;gap:20px}

.sidebar{background:#003366;color:#fff;padding:20px;border-radius:10px}
.sidebar a{display:block;color:#fff;text-decoration:none;padding:8px;border-radius:8px}
.sidebar a:hover{background:rgba(255,255,255,0.06)}

.main{background:#fff;padding:20px;border-radius:10px;box-shadow:0 2px 8px rgba(0,0,0,0.06)}

.hero{background:#fffdfc;padding:16px;border-radius:8px;border:1px solid #eef2f6;margin-bottom:20px}
.hero h2{margin:0;color:#003366}
.summary{font-size:26px;font-weight:700;color:#003366;margin-top:8px}

.grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:16px}

.card{background:#fff;padding:16px;border-radius:10px;border:1px solid #eef2f6}
.card h4{margin:0;color:#003366}
.card input{width:100%;padding:10px;border-radius:8px;border:1px solid #d8e1ea;margin-top:8px}

.btn{background:#003366;color:#fff;border:none;padding:12px 18px;border-radius:8px;font-weight:700;cursor:pointer}
.btn:hover{background:#002a53}

canvas{margin-top:20px}

footer{text-align:center;font-size:13px;color:#666;margin-top:20px}
</style>
</head>

<body>

<header>
  <div class="brand">
    <img src="pecos.png">
    <div>
      <div class="title">Pecos</div>
      <div style="font-size:12px;color:#fff9a8">Business Dashboard</div>
    </div>
  </div>
</header>

<div class="page">
<div class="layout">

<aside class="sidebar">
  <a href="member.html">← Member Dashboard</a>
</aside>

<main class="main">

<div class="hero">
  <h2>Revenue Overview</h2>
  <div class="summary" id="totalIncome">₹ 0</div>
</div>

<div class="grid">
  <div class="card"><h4>Interest</h4><input type="number" id="interestIncome"></div>
  <div class="card"><h4>Dividend</h4><input type="number" id="dividendIncome"></div>
  <div class="card"><h4>Rental</h4><input type="number" id="rentalIncome"></div>
  <div class="card"><h4>Trading</h4><input type="number" id="tradingIncome"></div>
  <div class="card"><h4>Brokerage</h4><input type="number" id="brokerageIncome"></div>
  <div class="card"><h4>Other</h4><input type="number" id="otherIncome"></div>
</div>

<button class="btn" style="margin-top:20px" onclick="saveIncome()">Save & Record</button>

<canvas id="growthChart"></canvas>
<canvas id="breakdownChart"></canvas>

</main>
</div>

<footer>© 2025 Pecos | Business Intelligence</footer>
</div>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyDnbqKwqvg9BoAjpgMBFCr3ZBOFOcuvZxs",
  authDomain: "pecos-432b5.firebaseapp.com",
  projectId: "pecos-432b5"
};

firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

let growthChart, breakdownChart;

auth.onAuthStateChanged(async user=>{
  if(!user) return location.href="index.html";
  const snap = await db.collection("members").doc(user.uid).get();
  if(!snap.exists || snap.data().role!=="admin") return location.href="member.html";
  document.body.style.display="block";
  loadData();
});

async function loadData(){
  const s = await db.collection("businessIncome").doc("summary").get();
  if(s.exists){
    const d=s.data();
    interestIncome.value=d.interestIncome||0;
    dividendIncome.value=d.dividenedIncome||0;
    rentalIncome.value=d.rentalIncome||0;
    tradingIncome.value=d.tradingIncome||0;
    brokerageIncome.value=d.brokerageIncome||0;
    otherIncome.value=d.otherIncome||0;
  }
  updateTotal();
  loadCharts();
}

function updateTotal(){
  const total=[interestIncome,dividendIncome,rentalIncome,tradingIncome,brokerageIncome,otherIncome]
    .reduce((t,i)=>t+(+i.value||0),0);
  totalIncome.innerText="₹ "+total;
  return total;
}

document.querySelectorAll("input").forEach(i=>i.oninput=updateTotal);

async function saveIncome(){
  const total=updateTotal();
  const data={
    interestIncome:+interestIncome.value,
    dividenedIncome:+dividendIncome.value,
    rentalIncome:+rentalIncome.value,
    tradingIncome:+tradingIncome.value,
    brokerageIncome:+brokerageIncome.value,
    otherIncome:+otherIncome.value,
    total,
    createdAt:new Date()
  };

  await db.collection("businessIncome").doc("summary").set({...data,updatedAt:new Date()});
  await db.collection("businessIncomeHistory").add(data);

  alert("Income saved & history recorded");
  loadCharts();
}

async function loadCharts(){
  const snap=await db.collection("businessIncomeHistory").orderBy("createdAt").get();
  const labels=[], totals=[];
  snap.forEach(d=>{
    labels.push(d.data().createdAt.toDate().toLocaleDateString("en-IN"));
    totals.push(d.data().total);
  });

  if(growthChart) growthChart.destroy();
  growthChart=new Chart(document.getElementById("growthChart"),{
    type:"line",
    data:{labels,datasets:[{label:"Total Revenue Growth",data:totals,borderWidth:2}]}
  });

  if(breakdownChart) breakdownChart.destroy();
  breakdownChart=new Chart(document.getElementById("breakdownChart"),{
    type:"bar",
    data:{
      labels:["Interest","Dividend","Rental","Trading","Brokerage","Other"],
      datasets:[{
        label:"Current Income",
        data:[
          interestIncome.value,
          dividendIncome.value,
          rentalIncome.value,
          tradingIncome.value,
          brokerageIncome.value,
          otherIncome.value
        ]
      }]
    }
  });
}
</script>

</body>
</html>
